---
- name: Ensure apt cache is updated
  apt:
    update_cache: yes
  become: true

- name: Install Jenkins dependencies
  apt:
    name: ["curl", "gnupg", "lsb-release", "git", "fontconfig", "openjdk-17-jre"]
    state: present
  become: true

- name: Add Jenkins apt key (keyring)
  ansible.builtin.shell: |
    install -m 0755 -d /usr/share/keyrings
    curl -fsSL https://pkg.jenkins.io/debian-stable/jenkins.io-2023.key | gpg --dearmor -o /usr/share/keyrings/jenkins-keyring.gpg
    chmod a+r /usr/share/keyrings/jenkins-keyring.gpg
  args:
    creates: /usr/share/keyrings/jenkins-keyring.gpg
  become: true

- name: Add Jenkins apt repository
  copy:
    dest: /etc/apt/sources.list.d/jenkins.list
    content: |
      deb [signed-by=/usr/share/keyrings/jenkins-keyring.gpg] https://pkg.jenkins.io/debian-stable binary/
    mode: '0644'
  become: true

- name: Update apt after adding Jenkins repo
  apt:
    update_cache: yes
  become: true

- name: Install Jenkins
  apt:
    name: jenkins
    state: present
  become: true

- name: Install Ansible (for Jenkins-driven deployments)
  apt:
    name: ansible
    state: present
    update_cache: yes
  become: true

- name: Ensure Jenkins service is enabled and started
  systemd:
    name: jenkins
    enabled: true
    state: started
  become: true

- name: Create systemd drop-in directory for Jenkins
  file:
    path: /etc/systemd/system/jenkins.service.d
    state: directory
    mode: '0755'
  become: true

- name: Ensure Jenkins has a sane PATH via systemd override
  copy:
    dest: /etc/systemd/system/jenkins.service.d/environment.conf
    content: |
      [Service]
      Environment="PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"
    mode: '0644'
  become: true

- name: Reload systemd and restart Jenkins to apply PATH
  systemd:
    daemon_reload: true
    name: jenkins
    state: restarted
  become: true

- name: Allow jenkins user sudo without password
  copy:
    dest: /etc/sudoers.d/jenkins
    content: |
      jenkins ALL=(ALL) NOPASSWD:ALL
    mode: '0440'
    validate: 'visudo -cf %s'
  become: true

- name: Add jenkins user to docker group
  user:
    name: jenkins
    groups: docker
    append: yes
  become: true

- name: Check docker socket
  stat:
    path: /var/run/docker.sock
  register: docker_sock
  become: true

- name: Ensure docker socket owned by root:docker and 0660
  file:
    path: /var/run/docker.sock
    owner: root
    group: docker
    mode: '0660'
  when: docker_sock.stat.exists
  become: true

- name: Restart Jenkins to pick up new group membership
  systemd:
    name: jenkins
    state: restarted
  become: true

- name: Wait for Jenkins to be up on port 8080
  wait_for:
    host: 127.0.0.1
    port: 8080
    delay: 5
    timeout: 120
  become: false

- name: Read Jenkins initial admin password
  shell: cat /var/lib/jenkins/secrets/initialAdminPassword
  register: jenkins_initial_admin_pass
  changed_when: false
  become: true

- name: Show Jenkins initial admin password
  debug:
    msg: "Jenkins initial admin password: {{ jenkins_initial_admin_pass.stdout }}"
