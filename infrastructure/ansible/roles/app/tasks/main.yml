---
- name: Check if git is installed
  command: git --version
  register: git_check
  ignore_errors: yes
  changed_when: false
  tags: [app]

- name: Check if curl is installed
  command: curl --version
  register: curl_check
  ignore_errors: yes
  changed_when: false
  tags: [app]

- name: Install git (without apt update)
  apt:
    name: git
    state: present
    update_cache: no
  become: yes
  when: git_check.rc != 0
  tags: [app]

- name: Install curl (without apt update)
  apt:
    name: curl
    state: present
    update_cache: no
  become: yes
  when: curl_check.rc != 0
  tags: [app]

- name: Ensure app directory exists
  file:
    path: /opt/personal-library
    state: directory
    owner: ansible
    group: ansible
    mode: '0755'
  become: yes
  tags: [app]

- name: Clone or update repository
  git:
    repo: "https://github.com/Pathum-Vimukthi-Kumara/Personal-Library-Management-System-DevOps.git"
    dest: /opt/personal-library
    version: master
    force: yes
  become: yes
  become_user: ansible
  tags: [app]

- name: Ensure Backend directory exists
  file:
    path: /opt/personal-library/Backend
    state: directory
    owner: ansible
    group: ansible
    mode: '0755'
  become: yes
  tags: [app]

- name: Ensure uploads/images directory exists
  file:
    path: /opt/personal-library/uploads/images
    state: directory
    owner: ansible
    group: ansible
    mode: '0755'
  become: yes
  tags: [app]

- name: Create backend .env file
  copy:
    content: |
      # Backend environment configuration
      SPRING_DATASOURCE_URL=jdbc:mysql://mysql:3306/librarydb
      SPRING_DATASOURCE_USERNAME=libraryuser
      SPRING_DATASOURCE_PASSWORD=librarypass
      SPRING_JPA_HIBERNATE_DDL_AUTO=update
      SPRING_JPA_SHOW_SQL=false
      SERVER_PORT=4000
    dest: /opt/personal-library/uploads/images/.env
    owner: ansible
    group: ansible
    mode: '0644'
  become: yes
  tags: [app]

- name: Compute JWT secret if undefined
  set_fact:
    computed_jwt_secret: "{{ jwt_secret | default(lookup('password', '/dev/null chars=ascii_letters,digits length=64')) }}"
  tags: [app]

- name: Set JWT values in backend .env
  lineinfile:
    path: /opt/personal-library/uploads/images/.env
    regexp: '^{{ item.key }}='
    line: '{{ item.key }}={{ item.value }}'
    create: yes
  loop:
    - { key: 'JWT_SECRET', value: '{{ computed_jwt_secret }}' }
    - { key: 'JWT_EXPIRATION', value: '86400000' }
  become: yes
  become_user: ansible
  tags: [app]

- name: Ensure uploads directory exists
  file:
    path: /opt/personal-library/uploads
    state: directory
    owner: ansible
    group: ansible
    mode: '0755'
  become: yes
  tags: [app]

- name: Ensure db-init.sql exists (create dummy if missing)
  stat:
    path: /opt/personal-library/db-init.sql
  register: db_init_file
  tags: [app]

- name: Create empty db-init.sql if it doesn't exist
  file:
    path: /opt/personal-library/db-init.sql
    state: touch
    owner: ansible
    group: ansible
    mode: '0644'
  become: yes
  when: not db_init_file.stat.exists
  tags: [app]

- name: Stop and remove existing containers
  shell: |
    export DEPLOY_TAG="{{ deploy_tag | default('latest') }}"
    docker compose -f compose.yaml down --remove-orphans
  args:
    chdir: /opt/personal-library
  become: yes
  become_user: ansible
  ignore_errors: yes
  tags: [app]

- name: Pull latest Docker images
  shell: |
    export DEPLOY_TAG="{{ deploy_tag | default('latest') }}"
    docker compose -f compose.yaml pull
  args:
    chdir: /opt/personal-library
  become: yes
  become_user: ansible
  tags: [app]
  register: pull_result

- name: Display pull result
  debug:
    var: pull_result.stdout_lines
  when: pull_result.stdout_lines is defined
  tags: [app]

- name: Check for Docker containers publishing host port 3008
  shell: |
    docker ps --format '{{.ID}} {{.Ports}}' | awk '/0.0.0.0:3008->/{print $1}' | tr '\n' ' '
  args:
    chdir: /opt/personal-library
  register: port3008_containers
  become: yes
  become_user: ansible
  changed_when: false
  tags: [app]

- name: Stop and remove containers using host port 3008
  shell: |
    for cid in {{ port3008_containers.stdout }}; do
      [ -n "$cid" ] || continue
      docker stop "$cid" || true
      docker rm "$cid" || true
    done
  args:
    chdir: /opt/personal-library
  when: port3008_containers.stdout != ''
  become: yes
  become_user: ansible
  tags: [app]

- name: Kill any non-docker process listening on port 3008
  shell: |
    # try fuser first, fall back to ss+kill
    if command -v fuser >/dev/null 2>&1; then
      fuser -k 3008/tcp || true
    else
      pid=$(ss -ltnp 2>/dev/null | awk '/:3008 /{print $6}' | sed -n 's/.*pid=\([0-9]*\),.*/\1/p' | head -n1)
      if [ -n "$pid" ]; then
        kill -9 "$pid" || true
      fi
    fi
  args:
    chdir: /opt/personal-library
  when: port3008_containers.stdout == ''
  become: yes
  become_user: ansible
  changed_when: false
  tags: [app]

- name: Start containers with docker compose
  shell: |
    export DEPLOY_TAG="{{ deploy_tag | default('latest') }}"
    docker compose -f compose.yaml up -d
  args:
    chdir: /opt/personal-library
  become: yes
  become_user: ansible
  tags: [app]
  register: compose_up

- name: Display compose up result
  debug:
    var: compose_up.stderr_lines
  when: compose_up.stderr_lines is defined
  tags: [app]

- name: Wait for containers to start
  pause:
    seconds: 20
  tags: [app]

- name: Check running containers
  command: docker ps
  register: container_status
  become: yes
  become_user: ansible
  tags: [app]

- name: Display container status
  debug:
    msg: "{{ container_status.stdout_lines }}"
  tags: [app]

- name: Check MySQL container health
  shell: docker inspect --format='{% raw %}{{.State.Health.Status}}{% endraw %}' $(docker ps -qf "name=mysql")
  register: mysql_health
  become: yes
  become_user: ansible
  ignore_errors: yes
  tags: [app]

- name: Check backend container health
  shell: docker inspect --format='{% raw %}{{.State.Health.Status}}{% endraw %}' $(docker ps -qf "name=backend")
  register: backend_health
  become: yes
  become_user: ansible
  ignore_errors: yes
  tags: [app]

- name: Display container health status
  debug:
    msg:
      - "MySQL Health: {{ mysql_health.stdout | default('N/A') }}"
      - "Backend Health: {{ backend_health.stdout | default('N/A') }}"
  tags: [app]

- name: Wait for frontend to be accessible
  wait_for:
    host: localhost
    port: 3008
    delay: 10
    timeout: 90
    state: started
  tags: [app]

- name: Check frontend accessibility
  uri:
    url: http://localhost:3008
    status_code: 200
    timeout: 5
  retries: 15
  delay: 5
  register: frontend_check
  until: frontend_check.status == 200
  tags: [app]

- name: Get backend logs (last 50 lines)
  shell: docker compose -f compose.yaml logs --tail=50 backend
  args:
    chdir: /opt/personal-library
  register: backend_logs
  become: yes
  become_user: ansible
  when: backend_health.stdout is defined and backend_health.stdout != 'healthy'
  tags: [app]

- name: Display backend logs if unhealthy
  debug:
    msg: "{{ backend_logs.stdout_lines }}"
  when: backend_logs.stdout_lines is defined
  tags: [app]

- name: Get MySQL logs if unhealthy
  shell: docker compose -f compose.yaml logs --tail=30 mysql
  args:
    chdir: /opt/personal-library
  register: mysql_logs
  become: yes
  become_user: ansible
  when: mysql_health.stdout is defined and mysql_health.stdout != 'healthy'
  tags: [app]

- name: Display MySQL logs if unhealthy
  debug:
    msg: "{{ mysql_logs.stdout_lines }}"
  when: mysql_logs.stdout_lines is defined
  tags: [app]

- name: Remove unused Docker images
  shell: docker image prune -af --filter "until=72h"
  become: yes
  become_user: ansible
  tags: [app]

- name: Final deployment summary
  debug:
    msg:
      - "=========================================="
      - "       DEPLOYMENT SUMMARY"
      - "=========================================="
      - "Deploy Tag: {{ deploy_tag | default('latest') }}"
      - "MySQL Status: {{ mysql_health.stdout | default('unknown') }}"
      - "Backend Status: {{ backend_health.stdout | default('unknown') }}"
      - "Frontend Status: {{ 'accessible' if frontend_check.status == 200 else 'not accessible' }}"
      - ""
      - "Application URL: http://{{ ansible_host }}:3008"
      - ""
      - "Deployment complete!"
  tags: [app]