---
- name: Install git
  apt:
    name: git
    state: present
    update_cache: yes
  become: true
  become_user: root
  tags: [app]

- name: Ensure app directory exists
  file:
    path: /opt/personal-library
    state: directory
    owner: ansible
    group: ansible
    mode: '0755'
  become: true
  become_user: root
  tags: [app]

- name: Clone or update repository
  git:
    repo: "https://github.com/Pathum-Vimukthi-Kumara/Personal-Library-Management-System-DevOps.git"
    dest: /opt/personal-library
    version: master
    force: yes
  become: true
  become_user: ansible
  tags: [app]

- name: Stop running containers
  shell: docker compose -f compose.yaml down
  args:
    chdir: /opt/personal-library
  ignore_errors: true
  become: true
  become_user: ansible
  tags: [app]

- name: Ensure backend env exists
  shell: |
    if [ ! -f Backend/.env ] && [ -f Backend/.env.example ]; then
      cp Backend/.env.example Backend/.env
    fi
  args:
    chdir: /opt/personal-library
  become: true
  become_user: ansible
  tags: [app]

- name: Compute JWT secret if undefined
  set_fact:
    computed_jwt_secret: "{{ jwt_secret | default(lookup('password', '/dev/null', chars='ascii_letters,digits', length=64)) }}"
  tags: [app]

- name: Set JWT values (from Ansible vars)
  lineinfile:
    path: /opt/personal-library/Backend/.env
    regexp: '^{{ item.key }}='
    line: '{{ item.key }}={{ item.value }}'
    create: yes
  loop:
    - { key: 'JWT_SECRET', value: '{{ computed_jwt_secret }}' }
    - { key: 'JWT_EXPIRATION', value: '86400000' }
  become: true
  become_user: ansible
  tags: [app]

\n+# Pull and deploy images from Docker Hub (built by Jenkins)
- name: Pull latest Docker images from Docker Hub
  command: docker compose -f compose.yaml pull
  args:
    chdir: /opt/personal-library
  become: true
  become_user: ansible
  tags: [app]

- name: Stop running containers
  command: docker compose -f compose.yaml down
  args:
    chdir: /opt/personal-library
  ignore_errors: true
  become: true
  become_user: ansible
  tags: [app]

- name: Start containers using pulled images
  command: docker compose -f compose.yaml up -d
  args:
    chdir: /opt/personal-library
  become: true
  become_user: ansible
  tags: [app]

# Optional cleanup of unused images
- name: Remove unused Docker images
  command: docker image prune -f
  become: true
  become_user: root
  tags: [app]

- name: Start containers
  shell: docker compose -f compose.yaml up -d
  args:
    chdir: /opt/personal-library
  become: true
  become_user: ansible
  tags: [app]

- name: Restart nginx
  service:
    name: nginx
    state: restarted
  become: true
  become_user: root
  tags: [app]
