---
- name: Install git
  apt:
    name: git
    state: present
    update_cache: yes
  become: true

- name: Ensure app directory exists
  file:
    path: /opt/personal-library
    state: directory
    mode: '0755'
  become: true

- name: Clone or update repository
  git:
    repo: "https://github.com/Pathum-Vimukthi-Kumara/Personal-Library-Management-System-DevOps.git"
    dest: /opt/personal-library
    version: master
    force: yes
  become: true

- name: Stop any existing containers
  ansible.builtin.shell: |
    docker compose -f /opt/personal-library/compose.yaml down || true
    docker compose -f /opt/personal-library/compose.prod.yaml down || true
  args:
    chdir: /opt/personal-library
  become: true
  ignore_errors: true

- name: Ensure backend env exists (create from example if missing)
  ansible.builtin.shell: |
    if [ ! -f Backend/.env ] && [ -f Backend/.env.example ]; then cp Backend/.env.example Backend/.env; fi
  args:
    chdir: /opt/personal-library
  become: true

- name: Ensure JWT secret is 256-bit and expiration set in Backend/.env
  ansible.builtin.shell: |
    # Set or update JWT_SECRET to a strong 256-bit value
    if grep -q '^JWT_SECRET=' Backend/.env; then
      sed -i 's/^JWT_SECRET=.*/JWT_SECRET=mySecretKey1234567890123456789012345678901234567890SecureKey256Bits/' Backend/.env
    else
      echo 'JWT_SECRET=mySecretKey1234567890123456789012345678901234567890SecureKey256Bits' >> Backend/.env
    fi
    # Set or update JWT_EXPIRATION to 24h
    if grep -q '^JWT_EXPIRATION=' Backend/.env; then
      sed -i 's/^JWT_EXPIRATION=.*/JWT_EXPIRATION=86400000/' Backend/.env
    else
      echo 'JWT_EXPIRATION=86400000' >> Backend/.env
    fi
  args:
    chdir: /opt/personal-library
  become: true

- name: Bring up services with Docker Compose
  ansible.builtin.shell: |
    # Rebuild images pulling latest base layers
    docker compose -f /opt/personal-library/compose.yaml build --pull
    docker compose -f /opt/personal-library/compose.yaml up -d
  args:
    chdir: /opt/personal-library
  become: true

- name: Restart nginx to pick up latest config/routes
  ansible.builtin.service:
    name: nginx
    state: restarted
    enabled: true
  become: true
