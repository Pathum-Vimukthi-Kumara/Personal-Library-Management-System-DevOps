---
- name: Install git
  apt:
    name: git
    state: present
    update_cache: yes
  become: yes
  tags: [app]

- name: Ensure app directory exists
  file:
    path: /opt/personal-library
    state: directory
    owner: ansible
    group: ansible
    mode: '0755'
  become: yes
  tags: [app]

- name: Clone or update repository
  git:
    repo: "https://github.com/Pathum-Vimukthi-Kumara/Personal-Library-Management-System-DevOps.git"
    dest: /opt/personal-library
    version: master
    force: yes
  become: yes
  become_user: ansible
  tags: [app]

- name: Ensure backend env exists
  shell: |
    if [ ! -f Backend/.env ] && [ -f Backend/.env.example ]; then
      cp Backend/.env.example Backend/.env
    fi
  args:
    chdir: /opt/personal-library
  become: yes
  become_user: ansible
  tags: [app]

- name: Compute JWT secret if undefined
  set_fact:
    computed_jwt_secret: "{{ jwt_secret | default(lookup('password', '/dev/null chars=ascii_letters,digits length=64')) }}"
  tags: [app]

- name: Set JWT values (from Ansible vars)
  lineinfile:
    path: /opt/personal-library/Backend/.env
    regexp: '^{{ item.key }}='
    line: '{{ item.key }}={{ item.value }}'
    create: yes
  loop:
    - { key: 'JWT_SECRET', value: '{{ computed_jwt_secret }}' }
    - { key: 'JWT_EXPIRATION', value: '86400000' }
  become: yes
  become_user: ansible
  tags: [app]

- name: Create .env file for docker compose
  copy:
    content: |
      DEPLOY_TAG={{ deploy_tag | default('latest') }}
    dest: /opt/personal-library/.env
    owner: ansible
    group: ansible
    mode: '0644'
  become: yes
  tags: [app]

- name: Pull latest Docker images from Docker Hub
  community.docker.docker_compose_v2:
    project_src: /opt/personal-library
    files:
      - compose.yaml
    state: present
    pull: always
  environment:
    DEPLOY_TAG: "{{ deploy_tag | default('latest') }}"
  become: yes
  become_user: ansible
  tags: [app]
  register: pull_result

- name: Stop running containers
  community.docker.docker_compose_v2:
    project_src: /opt/personal-library
    files:
      - compose.yaml
    state: absent
  environment:
    DEPLOY_TAG: "{{ deploy_tag | default('latest') }}"
  become: yes
  become_user: ansible
  ignore_errors: yes
  tags: [app]

- name: Start containers using pulled images
  community.docker.docker_compose_v2:
    project_src: /opt/personal-library
    files:
      - compose.yaml
    state: present
  environment:
    DEPLOY_TAG: "{{ deploy_tag | default('latest') }}"
  become: yes
  become_user: ansible
  tags: [app]
  register: compose_up

- name: Wait for backend to be healthy
  uri:
    url: http://localhost:8080/actuator/health
    status_code: 200
  retries: 30
  delay: 10
  become: yes
  tags: [app]
  ignore_errors: yes

- name: Wait for frontend to be healthy
  uri:
    url: http://localhost:3000
    status_code: 200
  retries: 30
  delay: 10
  become: yes
  tags: [app]
  ignore_errors: yes

- name: Remove unused Docker images
  docker_prune:
    images: yes
    images_filters:
      dangling: true
  become: yes
  tags: [app]

- name: Restart nginx
  service:
    name: nginx
    state: restarted
  become: yes
  tags: [app]