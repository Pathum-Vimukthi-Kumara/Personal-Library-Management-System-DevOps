pipeline {
    agent any

    options {
        timestamps()
        disableConcurrentBuilds()
        buildDiscarder(logRotator(numToKeepStr: '20'))
        parallelsAlwaysFailFast()
    }

    parameters {
        string(name: 'DROPLET_HOST', defaultValue: '143.198.162.25', description: 'DigitalOcean droplet IP or hostname')
        string(name: 'SSH_USER', defaultValue: 'ansible', description: 'SSH user on droplet')
        string(name: 'SSH_CREDENTIALS_ID', defaultValue: 'do-ssh-key', description: 'Jenkins SSH credential ID (Private Key)')
        string(name: 'REMOTE_DIR', defaultValue: '/opt/personal-library', description: 'Remote directory with compose files')
        string(name: 'COMPOSE_FILE', defaultValue: 'compose.yaml', description: 'Compose file to use (compose.yaml or compose.prod.yaml)')
        string(name: 'BRANCH', defaultValue: 'master', description: 'Git branch to deploy')
    }

    triggers {
        // Trigger via GitHub webhook on push
        githubPush()
    }

    environment {
        BACKEND_DIR  = 'Backend'
        FRONTEND_DIR = 'frontend/frontend'
    }

    stages {
        stage('Checkout') {
            steps {
                checkout scm
                sh 'echo "âœ“ Code checked out"'
            }
        }

        stage('Verify Workspace') {
            steps {
                sh 'echo "Backend dir:"; ls -la ${BACKEND_DIR} || true; echo "Frontend dir:"; ls -la ${FRONTEND_DIR} || true'
            }
        }

        stage('Deploy: Git Pull + Docker Compose (Remote)') {
            steps {
                script {
                    withCredentials([sshUserPrivateKey(credentialsId: params.SSH_CREDENTIALS_ID, keyFileVariable: 'SSH_KEY')]) {
                        sh '''
                            set -e
                            echo "=== Deploying to ${DROPLET_HOST} ==="
                            REMOTE_CMD=$(cat <<'RCMD'
set -e
echo "User: $(whoami)"
cd ${REMOTE_DIR}
echo "PWD: $(pwd)"
git fetch origin ${BRANCH}
git reset --hard origin/${BRANCH}
echo "Bringing containers down (if any)..."
docker compose -f ${COMPOSE_FILE} down || true
echo "Building and starting containers..."
docker compose -f ${COMPOSE_FILE} up -d --build
echo "Restarting nginx (if present)..."
sudo systemctl restart nginx || true
echo "=== Deploy complete ==="
RCMD
)
                            ssh -i "${SSH_KEY}" -o StrictHostKeyChecking=no ${SSH_USER}@${DROPLET_HOST} "bash -lc \"${REMOTE_CMD}\""
                        '''
                    }
                }
            }
        }

        stage('Smoke Test') {
            steps {
                sh '''
                    echo "Testing HTTP on http://${DROPLET_HOST}"
                    curl -sSf -m 20 http://${DROPLET_HOST} -I || true
                    echo "Checking frontend port 3008"
                    curl -sSf -m 20 http://${DROPLET_HOST}:3008 | head -c 200 || true
                    echo "Checking backend health on 5001 (optional)"
                    curl -s -m 10 http://${DROPLET_HOST}:5001/actuator/health || true
                '''
            }
        }
    }

    post {
        success { echo 'PIPELINE SUCCESSFUL!' }
        failure { echo 'PIPELINE FAILED!' }
        always  { echo '=== Pipeline finished ===' }
    }
}