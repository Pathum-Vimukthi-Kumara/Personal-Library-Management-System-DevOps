pipeline {// Jenkinsfile for building and deploying Personal Library application using Ansible
    agent any

    options {
        timestamps()
        disableConcurrentBuilds()
        buildDiscarder(logRotator(numToKeepStr: '15'))
        parallelsAlwaysFailFast()
    }

    parameters {
        string(name: 'COMPOSE_DIR', defaultValue: '/opt/personal-library', description: 'Directory on server containing compose files')
        string(name: 'ANSIBLE_INVENTORY', defaultValue: 'infrastructure/ansible/inventory.ini', description: 'Path to Ansible inventory in repo (DigitalOcean droplet)')
        string(name: 'ANSIBLE_PLAYBOOK', defaultValue: 'infrastructure/ansible/site.yml', description: 'Path to Ansible playbook in repo')
        string(name: 'ANSIBLE_TAGS', defaultValue: '', description: 'Ansible tags to run for deployment (optional)')
        string(name: 'ANSIBLE_CREDENTIALS_ID', defaultValue: 'do-ssh-key', description: 'Jenkins SSH credential ID for Droplet (optional). If empty, uses /var/lib/jenkins/.ssh/id_rsa')
    }

    triggers {
        // Trigger on GitHub push via webhook (configure in Jenkins)
        githubPush()
    }

    environment {
        BACKEND_DIR      = 'Backend'
        FRONTEND_DIR     = 'frontend/frontend'
        IMAGE_TAG_BUILD  = "${env.BUILD_NUMBER}"
        IMAGE_TAG_COMMIT = "${env.GIT_COMMIT?.take(12) ?: env.BUILD_NUMBER}"
        DEFAULT_SSH_KEY  = '/var/lib/jenkins/.ssh/id_rsa'
    }

    stages {
        stage('Checkout & Setup') {
            steps {
                checkout scm
                sh """
                    echo "=== Setting up workspace ==="
                    chmod +x ${env.BACKEND_DIR}/mvnw || true
                    echo "✓ Checkout completed"
                """
                                                        sshagent(credentials: [params.ANSIBLE_CREDENTIALS_ID]) {
        }

        stage('Verify Environment') {
            steps {
                sh """
                    echo "=== Environment Verification ==="
                    echo "Workspace: ${env.WORKSPACE}"
                                                                USER=root
                    echo "Git Commit: ${env.GIT_COMMIT}"
                    echo "Backend Dir: ${env.BACKEND_DIR}"
                                                                        -e ansible_user=\${USER} -e "ansible_ssh_common_args='-o StrictHostKeyChecking=no'"

                    echo "=== Directory Structure ==="
                                                                        -e ansible_user=\${USER} -e "ansible_ssh_common_args='-o StrictHostKeyChecking=no'"
                    ls -la ${env.BACKEND_DIR}/ || echo "Backend directory not found"
                    echo "Frontend contents:"
                    ls -la ${env.FRONTEND_DIR}/ || echo "Frontend directory not found"

                    echo "=== Tools Verification ==="
                                                        echo "ssh-agent deploy failed; falling back to key file. Error: ${err}"
                    docker --version || echo "Docker not available"
                    echo "✓ Environment verification completed"
                """
            }
        }

        stage('Build Backend') {
            steps {
                dir("${env.BACKEND_DIR}") {
                    sh """
                        echo "=== Building Backend Application ==="
                        chmod +x ./mvnw || true
                        ./mvnw -B -DskipTests=true clean compile
                        echo "✓ Backend build completed"
                    """
                }
            }
        }

        // Docker build and verification stages removed. Deployment is handled via Ansible.

                stage('Deploy via Ansible') {
                        steps {
                                dir("${env.WORKSPACE}") {
                                        script {
                                            if (params.ANSIBLE_CREDENTIALS_ID?.trim()) {
                                                try {
                                                    withCredentials([sshUserPrivateKey(credentialsId: params.ANSIBLE_CREDENTIALS_ID, keyFileVariable: 'SSH_KEY', usernameVariable: 'SSH_USER')]) {
                                                        sh """
                                                            set -e
                                                            echo "=== Deploying via Ansible ==="
                                                            echo "Inventory: ${params.ANSIBLE_INVENTORY}"
                                                            echo "Playbook:  ${params.ANSIBLE_PLAYBOOK}"
                                                            echo "Tags:      ${params.ANSIBLE_TAGS}"
                                                            echo "Using Jenkins credential key: \${SSH_KEY} (user: \${SSH_USER})"
                                                            export ANSIBLE_HOST_KEY_CHECKING=False
                                                            USER=\${SSH_USER:-root}
                                                            if [ -n "${params.ANSIBLE_TAGS}" ]; then
                                                                /usr/bin/ansible-playbook -i ${params.ANSIBLE_INVENTORY} ${params.ANSIBLE_PLAYBOOK} --tags ${params.ANSIBLE_TAGS} \
                                                                    -e ansible_user=\${USER} -e ansible_ssh_private_key_file=\${SSH_KEY} -e "ansible_ssh_common_args='-o StrictHostKeyChecking=no'"
                                                            else
                                                                /usr/bin/ansible-playbook -i ${params.ANSIBLE_INVENTORY} ${params.ANSIBLE_PLAYBOOK} \
                                                                    -e ansible_user=\${USER} -e ansible_ssh_private_key_file=\${SSH_KEY} -e "ansible_ssh_common_args='-o StrictHostKeyChecking=no'"
                                                            fi
                                                            echo "✓ Ansible deployment completed"
                                                        """
                                                    }
                                                } catch (err) {
                                                    echo "Credential '${params.ANSIBLE_CREDENTIALS_ID}' missing or invalid; falling back to default SSH key. Error: ${err}"
                                                    sh """
                                                        set -e
                                                        echo "=== Deploying via Ansible (fallback) ==="
                                                        export ANSIBLE_HOST_KEY_CHECKING=False
                                                        KEY=${env.DEFAULT_SSH_KEY}
                                                        echo "Using default key: \${KEY}"
                                                        if [ ! -f "\${KEY}" ]; then
                                                            echo "ERROR: SSH key not found at \${KEY}. Provide ANSIBLE_CREDENTIALS_ID or place key there."
                                                            exit 1
                                                        fi
                                                        if [ -n "${params.ANSIBLE_TAGS}" ]; then
                                                            /usr/bin/ansible-playbook -i ${params.ANSIBLE_INVENTORY} ${params.ANSIBLE_PLAYBOOK} --tags ${params.ANSIBLE_TAGS} \
                                                                -e ansible_user=root -e ansible_ssh_private_key_file=\${KEY} -e "ansible_ssh_common_args='-o StrictHostKeyChecking=no'"
                                                        else
                                                            /usr/bin/ansible-playbook -i ${params.ANSIBLE_INVENTORY} ${params.ANSIBLE_PLAYBOOK} \
                                                                -e ansible_user=root -e ansible_ssh_private_key_file=\${KEY} -e "ansible_ssh_common_args='-o StrictHostKeyChecking=no'"
                                                        fi
                                                        echo "✓ Ansible deployment completed (fallback)"
                                                    """
                                                }
                                            } else {
                                                sh """
                                                    set -e
                                                    echo "=== Deploying via Ansible ==="
                                                    echo "Inventory: ${params.ANSIBLE_INVENTORY}"
                                                    echo "Playbook:  ${params.ANSIBLE_PLAYBOOK}"
                                                    echo "Tags:      ${params.ANSIBLE_TAGS}"
                                                    export ANSIBLE_HOST_KEY_CHECKING=False
                                                    KEY=${env.DEFAULT_SSH_KEY}
                                                    echo "Using default key: \${KEY}"
                                                    if [ ! -f "\${KEY}" ]; then
                                                        echo "ERROR: SSH key not found at \${KEY}. Provide ANSIBLE_CREDENTIALS_ID or place key there."
                                                        exit 1
                                                    fi
                                                    if [ -n "${params.ANSIBLE_TAGS}" ]; then
                                                        /usr/bin/ansible-playbook -i ${params.ANSIBLE_INVENTORY} ${params.ANSIBLE_PLAYBOOK} --tags ${params.ANSIBLE_TAGS} \
                                                            -e ansible_user=root -e ansible_ssh_private_key_file=\${KEY} -e "ansible_ssh_common_args='-o StrictHostKeyChecking=no'"
                                                    else
                                                        /usr/bin/ansible-playbook -i ${params.ANSIBLE_INVENTORY} ${params.ANSIBLE_PLAYBOOK} \
                                                            -e ansible_user=root -e ansible_ssh_private_key_file=\${KEY} -e "ansible_ssh_common_args='-o StrictHostKeyChecking=no'"
                                                    fi
                                                    echo "✓ Ansible deployment completed"
                                                """
                                            }
                                        }
                                }
                        }
                }

                stage('Smoke Test') {
                    steps {
                        script {
                            def tf = readFile('infrastructure/terraform/terraform.tfstate')
                            def json = new groovy.json.JsonSlurperClassic().parseText(tf)
                            def dropletIp = json?.outputs?.droplet_ip?.value ?: ''
                            if (!dropletIp) {
                                error 'Droplet IP not found in terraform.tfstate outputs.droplet_ip.value'
                            }
                            env.DROPLET_IP = dropletIp
                        }
                        sh """
                            echo "=== Smoke Test ==="
                            echo "Checking frontend at http://${DROPLET_IP}:3008"
                            # Fail if curl errors or non-200 without content
                            curl -sSf -m 20 http://${DROPLET_IP}:3008 | head -c 200 > /dev/null
                            echo "✓ Frontend reachable"
                            echo "Checking backend health at http://${DROPLET_IP}:5001/actuator/health (optional)"
                            curl -s -m 10 http://${DROPLET_IP}:5001/actuator/health || true
                        """
                    }
                }
    }

    post {
        success {
            echo 'PIPELINE SUCCESSFUL!'
        }
        failure {
            echo 'PIPELINE FAILED!'
            sh """
                echo "=== Debug Information ==="
                echo "Current directory:"
                pwd
                ls -la
            """
        }
        always {
            echo '=== Post Build Cleanup ==='
            sh """
                echo "No Docker cleanup required for Ansible-only pipeline"
            """
        }
    }
}