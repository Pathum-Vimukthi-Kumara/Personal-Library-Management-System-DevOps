pipeline {
    agent any

    options {
        timestamps()
        disableConcurrentBuilds()
        buildDiscarder(logRotator(numToKeepStr: '20'))
    }

    /* ===== GITHUB WEBHOOK TRIGGER ===== */
    triggers {
        githubPush()
    }

    environment {
        DOCKERHUB_USER = ''
        BACKEND_IMAGE  = 'personal-library-backend'
        FRONTEND_IMAGE = 'personal-library-frontend'
        SERVER_IP      = '45.55.107.160'
    }

    stages {

        /* ================= CI ================= */

        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Docker Info') {
            steps {
                sh '''
                    echo "Checking Docker connectivity..."
                    docker info || (echo "Docker is not accessible from Jenkins agent" && exit 1)
                '''
            }
        }

        stage('Build Backend Image') {
            steps {
                withCredentials([
                    usernamePassword(
                        credentialsId: 'dockerhub-creds',
                        usernameVariable: 'DH_USER',
                        passwordVariable: 'DH_PASS'
                    )
                ]) {
                    sh '''
                        docker build \
                          -t $DH_USER/$BACKEND_IMAGE:latest \
                          Backend
                    '''
                }
            }
        }

        stage('Build Frontend Image') {
            steps {
                withCredentials([
                    usernamePassword(
                        credentialsId: 'dockerhub-creds',
                        usernameVariable: 'DH_USER',
                        passwordVariable: 'DH_PASS'
                    )
                ]) {
                    sh '''
                        docker build \
                          -t $DH_USER/$FRONTEND_IMAGE:latest \
                          frontend/frontend
                    '''
                }
            }
        }

        stage('Push Images to Docker Hub') {
            steps {
                withCredentials([
                    usernamePassword(
                        credentialsId: 'dockerhub-creds',
                        usernameVariable: 'DH_USER',
                        passwordVariable: 'DH_PASS'
                    )
                ]) {
                    sh '''
                        echo "$DH_PASS" | docker login -u "$DH_USER" --password-stdin
                        docker push $DH_USER/$BACKEND_IMAGE:latest
                        docker push $DH_USER/$FRONTEND_IMAGE:latest
                        docker logout
                    '''
                }
            }
        }

        /* ================= CD ================= */

        stage('Ansible Preflight') {
            steps {
                withCredentials([
                    sshUserPrivateKey(
                        credentialsId: 'do-ssh-key',
                        keyFileVariable: 'SSH_KEY'
                    )
                ]) {
                    sh '''
                        set -e
                        export ANSIBLE_HOST_KEY_CHECKING=False
                        ansible --version
                        # Host connectivity check
                        ansible -i infrastructure/ansible/inventory.ini app -m ping -e "ansible_ssh_private_key_file=$SSH_KEY"
                        # Playbook syntax check
                        ansible-playbook --syntax-check -i infrastructure/ansible/inventory.ini infrastructure/ansible/site.yml
                    '''
                }
            }
        }

        stage('Deploy with Ansible') {
            steps {
                withCredentials([
                    sshUserPrivateKey(
                        credentialsId: 'do-ssh-key',
                        keyFileVariable: 'SSH_KEY'
                    )
                ]) {
                    sh '''
                        set -e
                        export ANSIBLE_HOST_KEY_CHECKING=False
                        PUB_KEY="$(ssh-keygen -y -f "$SSH_KEY")"
                        EXTRA_VARS_PATH="$(mktemp)"
                        cat > "$EXTRA_VARS_PATH" <<EOF
{"ansible_ssh_private_key_file":"$SSH_KEY","ansible_public_key":"$PUB_KEY"}
EOF

                        ansible-playbook \
                          -i infrastructure/ansible/inventory.ini \
                          infrastructure/ansible/site.yml \
                          --extra-vars "@${EXTRA_VARS_PATH}" \
                          -vv

                        rm -f "$EXTRA_VARS_PATH"
                    '''
                }
            }
        }

        stage('Ansible Verify') {
            steps {
                withCredentials([
                    sshUserPrivateKey(
                        credentialsId: 'do-ssh-key',
                        keyFileVariable: 'SSH_KEY'
                    )
                ]) {
                    sh '''
                        set -e
                        export ANSIBLE_HOST_KEY_CHECKING=False
                        # List running containers
                        ansible -i infrastructure/ansible/inventory.ini app -m shell -e "ansible_ssh_private_key_file=$SSH_KEY" -a "docker ps"
                        # Check health via curl from the server
                        ansible -i infrastructure/ansible/inventory.ini app -m shell -e "ansible_ssh_private_key_file=$SSH_KEY" -a "curl -sf http://localhost:3008/api/actuator/health"
                    '''
                }
            }
        }

        stage('Smoke Test') {
            steps {
                sh '''
                    curl -f http://$SERVER_IP:3008 || true
                    curl -f http://$SERVER_IP:3008/api/actuator/health || true
                '''
            }
        }
    }

    post {
        success {
            echo '✅ CI/CD PIPELINE SUCCESSFUL'
        }
        failure {
            echo '❌ CI/CD PIPELINE FAILED'
        }
        always {
            echo '=== Pipeline finished ==='
        }
    }
}
