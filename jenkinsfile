pipeline {
    agent any

    options {
        timestamps()
        disableConcurrentBuilds()
        buildDiscarder(logRotator(numToKeepStr: '20'))
    }

    /* ===== GITHUB WEBHOOK TRIGGER ===== */
    triggers {
        githubPush()
    }

    environment {
        DOCKERHUB_USER = ''
        BACKEND_IMAGE  = 'personal-library-backend'
        FRONTEND_IMAGE = 'personal-library-frontend'
        SERVER_IP      = '45.55.107.160'
    }

    stages {

        /* ================= CI ================= */

        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Docker Info') {
            steps {
                sh '''
                    echo "Checking Docker connectivity..."
                    docker info || (echo "Docker is not accessible from Jenkins agent" && exit 1)
                '''
            }
        }

        stage('Build Backend Image') {
            steps {
                withCredentials([
                    usernamePassword(
                        credentialsId: 'dockerhub-creds',
                        usernameVariable: 'DH_USER',
                        passwordVariable: 'DH_PASS'
                    )
                ]) {
                    sh '''
                        docker build \
                          -t $DH_USER/$BACKEND_IMAGE:latest \
                          Backend
                    '''
                }
            }
        }

        stage('Build Frontend Image') {
            steps {
                withCredentials([
                    usernamePassword(
                        credentialsId: 'dockerhub-creds',
                        usernameVariable: 'DH_USER',
                        passwordVariable: 'DH_PASS'
                    )
                ]) {
                    sh '''
                        docker build \
                          -t $DH_USER/$FRONTEND_IMAGE:latest \
                          frontend/frontend
                    '''
                }
            }
        }

        stage('Push Images to Docker Hub') {
            steps {
                withCredentials([
                    usernamePassword(
                        credentialsId: 'dockerhub-creds',
                        usernameVariable: 'DH_USER',
                        passwordVariable: 'DH_PASS'
                    )
                ]) {
                    sh '''
                        echo "$DH_PASS" | docker login -u "$DH_USER" --password-stdin
                        docker push $DH_USER/$BACKEND_IMAGE:latest
                        docker push $DH_USER/$FRONTEND_IMAGE:latest
                        docker logout
                    '''
                }
            }
        }

        /* ================= CD ================= */

        stage('Deploy with Ansible') {
            steps {
                withCredentials([
                    sshUserPrivateKey(
                        credentialsId: 'do-ssh-key',
                        keyFileVariable: 'SSH_KEY'
                    )
                ]) {
                    sh '''
                        export ANSIBLE_HOST_KEY_CHECKING=False
                                                PUB_KEY="$(ssh-keygen -y -f \"$SSH_KEY\")"

                                                ansible-playbook \
                                                    -i infrastructure/ansible/inventory.ini \
                                                    infrastructure/ansible/site.yml \
                                                    --extra-vars "$(printf '{"ansible_ssh_private_key_file":"%s","ansible_public_key":"%s"}' \"$SSH_KEY\" \"$PUB_KEY\")" \
                                                    -vv
                    '''
                }
            }
        }

        stage('Smoke Test') {
            steps {
                sh '''
                    curl -f http://$SERVER_IP:3008 || true
                    curl -f http://$SERVER_IP:3008/api/actuator/health || true
                '''
            }
        }
    }

    post {
        success {
            echo '✅ CI/CD PIPELINE SUCCESSFUL'
        }
        failure {
            echo '❌ CI/CD PIPELINE FAILED'
        }
        always {
            echo '=== Pipeline finished ==='
        }
    }
}
