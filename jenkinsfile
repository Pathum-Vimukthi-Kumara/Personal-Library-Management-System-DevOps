pipeline {
    agent any

    options {
        timestamps()
        disableConcurrentBuilds()
        buildDiscarder(logRotator(numToKeepStr: '15'))
        parallelsAlwaysFailFast()
    }

    parameters {
        string(name: 'COMPOSE_DIR', defaultValue: '/opt/personal-library', description: 'Directory on server containing compose files')
        string(name: 'ANSIBLE_INVENTORY', defaultValue: 'infrastructure/ansible/inventory.local.ini', description: 'Path to Ansible inventory in repo')
        string(name: 'ANSIBLE_PLAYBOOK', defaultValue: 'infrastructure/ansible/site.yml', description: 'Path to Ansible playbook in repo')
        string(name: 'ANSIBLE_TAGS', defaultValue: 'app', description: 'Ansible tags to run for deployment (optional)')
    }

    triggers {
        // Poll SCM every minute
        pollSCM('H/1 * * * *')
    }

    environment {
        BACKEND_DIR      = 'Backend'
        FRONTEND_DIR     = 'frontend/frontend'
        IMAGE_TAG_BUILD  = "${env.BUILD_NUMBER}"
        IMAGE_TAG_COMMIT = "${env.GIT_COMMIT?.take(12) ?: env.BUILD_NUMBER}"
    }

    stages {
        stage('Checkout & Setup') {
            steps {
                checkout scm
                sh """
                    echo "=== Setting up workspace ==="
                    chmod +x ${env.BACKEND_DIR}/mvnw || true
                    echo "✓ Checkout completed"
                """
            }
        }

        stage('Verify Environment') {
            steps {
                sh """
                    echo "=== Environment Verification ==="
                    echo "Workspace: ${env.WORKSPACE}"
                    echo "Build Number: ${env.BUILD_NUMBER}"
                    echo "Git Commit: ${env.GIT_COMMIT}"
                    echo "Backend Dir: ${env.BACKEND_DIR}"
                    echo "Frontend Dir: ${env.FRONTEND_DIR}"

                    echo "=== Directory Structure ==="
                    echo "Backend contents:"
                    ls -la ${env.BACKEND_DIR}/ || echo "Backend directory not found"
                    echo "Frontend contents:"
                    ls -la ${env.FRONTEND_DIR}/ || echo "Frontend directory not found"

                    echo "=== Tools Verification ==="
                    java -version || echo "Java not available"
                    docker --version || echo "Docker not available"
                    echo "✓ Environment verification completed"
                """
            }
        }

        stage('Build Backend') {
            steps {
                dir("${env.BACKEND_DIR}") {
                    sh """
                        echo "=== Building Backend Application ==="
                        chmod +x ./mvnw || true
                        ./mvnw -B -DskipTests=true clean compile
                        echo "✓ Backend build completed"
                    """
                }
            }
        }

        stage('Build Docker Images') {
            parallel {
                stage('Backend Image') {
                    steps {
                        dir("${env.BACKEND_DIR}") {
                            script {
                                def base = 'personal-library-backend'
                                if (!fileExists('Dockerfile')) {
                                    error 'Dockerfile not found in backend directory'
                                }
                                sh """
                                    echo "Building Docker image: ${base}"
                                    docker build \
                                        --no-cache \
                                        -t ${base}:${env.IMAGE_TAG_BUILD} \
                                        -t ${base}:latest .
                                    echo "✓ Backend Docker image built successfully"
                                """
                                sh """
                                    echo "Verifying backend image:"
                                    docker images | grep "${base}" || echo "Backend image not found after build"
                                """
                            }
                        }
                    }
                }
                stage('Frontend Image') {
                    steps {
                        dir("${env.FRONTEND_DIR}") {
                            script {
                                def base = 'personal-library-frontend'
                                if (!fileExists('Dockerfile')) {
                                    echo 'WARNING: No Dockerfile in frontend directory, skipping frontend build'
                                    return
                                }
                                sh """
                                    echo "Building Docker image: ${base}"
                                    docker build \
                                        --no-cache \
                                        -t ${base}:${env.IMAGE_TAG_BUILD} \
                                        -t ${base}:latest .
                                    echo "✓ Frontend Docker image built successfully"
                                """
                                sh """
                                    echo "Verifying frontend image:"
                                    docker images | grep "${base}" || echo "Frontend image not found after build"
                                """
                            }
                        }
                    }
                }
            }
        }

        stage('Verify Docker Images') {
            steps {
                sh """
                    echo "=== Verifying Docker Images ==="
                    echo "List of personal-library images:"
                    docker images | grep 'personal-library-' || echo 'No personal-library images found'
                    echo "Total Docker images on system:"
                    docker images | wc -l || true
                """
            }
        }

        stage('Deploy via Ansible') {
            steps {
                dir("${env.WORKSPACE}") {
                    sh """
                        set -e
                        echo "=== Deploying via Ansible ==="
                        ansible --version
                        echo "Inventory: ${params.ANSIBLE_INVENTORY}"
                        echo "Playbook:  ${params.ANSIBLE_PLAYBOOK}"
                        echo "Tags:      ${params.ANSIBLE_TAGS}"
                        # Run playbook with tags (if provided)
                        if [ -n "${params.ANSIBLE_TAGS}" ]; then
                          ansible-playbook -i ${params.ANSIBLE_INVENTORY} ${params.ANSIBLE_PLAYBOOK} --tags ${params.ANSIBLE_TAGS}
                        else
                          ansible-playbook -i ${params.ANSIBLE_INVENTORY} ${params.ANSIBLE_PLAYBOOK}
                        fi
                        echo "✓ Ansible deployment completed"
                    """
                }
            }
        }
    }

    post {
        success {
            echo 'PIPELINE SUCCESSFUL!'
        }
        failure {
            echo 'PIPELINE FAILED!'
            sh """
                echo "=== Debug Information ==="
                echo "Current directory:"
                pwd
                ls -la
                echo "Docker images:"
                docker images | head -10
            """
        }
        always {
            echo '=== Cleaning Up ==='
            sh """
                echo "Cleaning up Docker resources..."
                docker image prune -f || echo 'Docker cleanup failed'
                echo "✓ Cleanup completed"
            """
        }
    }
}