pipeline {
    agent any

    options {
        timestamps()
        disableConcurrentBuilds()
        buildDiscarder(logRotator(numToKeepStr: '20'))
        parallelsAlwaysFailFast()
    }

    parameters {
        string(name: 'DROPLET_HOST', defaultValue: '143.198.162.25', description: 'DigitalOcean droplet IP or hostname')
        string(name: 'SSH_USER', defaultValue: 'ansible', description: 'SSH user on droplet')
        string(name: 'SSH_CREDENTIALS_ID', defaultValue: 'do-ssh-key', description: 'Jenkins SSH credential ID (Private Key)')
        string(name: 'REMOTE_DIR', defaultValue: '/opt/personal-library', description: 'Remote directory with compose files')
        string(name: 'COMPOSE_FILE', defaultValue: 'compose.yaml', description: 'Compose file to use (compose.yaml or compose.prod.yaml)')
        string(name: 'BRANCH', defaultValue: 'master', description: 'Git branch to deploy')
        // Ansible-related (optional)
        string(name: 'ANSIBLE_INVENTORY', defaultValue: 'infrastructure/ansible/inventory.ini', description: 'Path to Ansible inventory in repo')
        string(name: 'ANSIBLE_PLAYBOOK', defaultValue: 'infrastructure/ansible/site.yml', description: 'Path to Ansible playbook in repo')
        string(name: 'ANSIBLE_TAGS', defaultValue: '', description: 'Optional Ansible tags (e.g., setup,docker,app,nginx)')
    }

    triggers {
        // Trigger via GitHub webhook on push
        githubPush()
    }

    environment {
        BACKEND_DIR  = 'Backend'
        FRONTEND_DIR = 'frontend/frontend'
    }

    stages {
        stage('Checkout') {
            steps {
                checkout scm
                sh 'echo "âœ“ Code checked out"'
            }
        }

        stage('Verify Workspace') {
            steps {
                sh 'echo "Backend dir:"; ls -la ${BACKEND_DIR} || true; echo "Frontend dir:"; ls -la ${FRONTEND_DIR} || true'
            }
        }

        stage('Provision: Ansible (Optional)') {
            steps {
                script {
                    def inv = params.ANSIBLE_INVENTORY?.trim()
                    def play = params.ANSIBLE_PLAYBOOK?.trim()
                    def tags = params.ANSIBLE_TAGS?.trim()
                    def tagsArg = tags ? "--tags \"${tags}\"" : ""
                    // Run Ansible only if installed on Jenkins controller
                    sh 'if ! command -v ansible-playbook >/dev/null 2>&1; then echo "Ansible not installed on Jenkins controller; skipping provisioning stage"; exit 0; fi'
                    withCredentials([sshUserPrivateKey(credentialsId: params.SSH_CREDENTIALS_ID, keyFileVariable: 'SSH_KEY')]) {
                        sh """
                            set -e
                            echo "=== Provisioning via Ansible ==="
                            export ANSIBLE_HOST_KEY_CHECKING=False
                            ansible-playbook -i ${inv} ${play} --private-key "${SSH_KEY}" -e ansible_ssh_private_key_file="${SSH_KEY}" ${tagsArg} -vv || echo "WARN: Ansible provisioning encountered issues"
                        """
                    }
                }
            }
        }

        stage('Deploy: Git Pull + Docker Compose (Remote)') {
            steps {
                script {
                    def host = params.DROPLET_HOST?.trim()
                    def user = params.SSH_USER?.trim()
                    def remoteDir = params.REMOTE_DIR?.trim()
                    def composeFile = params.COMPOSE_FILE?.trim()
                    def branch = params.BRANCH?.trim()
                    if (!host || !user) {
                        error "Missing SSH parameters: DROPLET_HOST='${host}', SSH_USER='${user}'"
                    }
                    withCredentials([sshUserPrivateKey(credentialsId: params.SSH_CREDENTIALS_ID, keyFileVariable: 'SSH_KEY')]) {
                        sh """
                            set -e
                            echo "=== Deploying to ${host} as ${user} ==="
                            ssh -i "${SSH_KEY}" -o StrictHostKeyChecking=no ${user}@${host} "bash -lc 'set -e; \
                                # Ensure repo ownership matches SSH user to avoid Git dubious ownership
                                sudo chown -R ${user}:${user} ${remoteDir} || true; \
                                # Allow Git to operate in this directory
                                git config --global --add safe.directory ${remoteDir}; \
                                cd ${remoteDir}; \
                                # Make sure remote is set (optional, harmless if already configured)
                                git remote set-url origin https://github.com/Pathum-Vimukthi-Kumara/Personal-Library-Management-System-DevOps.git || true; \
                                git fetch origin ${branch}; \
                                git reset --hard origin/${branch}; \
                                docker compose -f ${composeFile} down || true; \
                                docker compose -f ${composeFile} up -d --build; \
                                sudo systemctl restart nginx || true'"
                        """
                    }
                }
            }
        }

        stage('Smoke Test') {
            steps {
                sh '''
                    echo "Testing HTTP on http://${DROPLET_HOST}"
                    curl -sSf -m 20 http://${DROPLET_HOST} -I || true
                    echo "Checking frontend port 3008"
                    curl -sSf -m 20 http://${DROPLET_HOST}:3008 | head -c 200 || true
                    echo "Checking backend health on 5001 (optional)"
                    curl -s -m 10 http://${DROPLET_HOST}:5001/actuator/health || true
                '''
            }
        }
    }

    post {
        success { echo 'PIPELINE SUCCESSFUL!' }
        failure { echo 'PIPELINE FAILED!' }
        always  { echo '=== Pipeline finished ===' }
    }
}