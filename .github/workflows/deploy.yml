name: Deploy to DigitalOcean via Terraform + Ansible

on:
  push:
    branches: [ "main", "master" ]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  deploy:
    name: Provision and Deploy
    runs-on: ubuntu-latest
    env:
      TF_IN_AUTOMATION: "true"
      ANSIBLE_HOST_KEY_CHECKING: "False"
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.6

      - name: Prepare SSH keys for Terraform/Ansible
        id: sshkeys
        shell: bash
        env:
          DO_SSH_PUBLIC_KEY: ${{ secrets.DO_SSH_PUBLIC_KEY }}
          DO_SSH_PRIVATE_KEY: ${{ secrets.DO_SSH_PRIVATE_KEY }}
        run: |
          set -euo pipefail
          if [ -z "${DO_SSH_PUBLIC_KEY:-}" ] || [ -z "${DO_SSH_PRIVATE_KEY:-}" ]; then
            echo "Missing DO_SSH_PUBLIC_KEY or DO_SSH_PRIVATE_KEY secrets" >&2
            exit 1
          fi
          PUB="$RUNNER_TEMP/do_key.pub"
          PRIV="$RUNNER_TEMP/do_key"
          printf "%s\n" "$DO_SSH_PUBLIC_KEY" > "$PUB"
          printf "%s\n" "$DO_SSH_PRIVATE_KEY" > "$PRIV"
          chmod 600 "$PRIV" "$PUB"
          echo "pub=$PUB" >> "$GITHUB_OUTPUT"
          echo "priv=$PRIV" >> "$GITHUB_OUTPUT"

      - name: Terraform init/plan/apply (DigitalOcean)
        working-directory: infrastructure/terraform
        env:
          TF_VAR_do_token: ${{ secrets.DO_TOKEN }}
        run: |
          set -euo pipefail
          terraform init -input=false
          # Override ssh_key_path with the temp public key; keep other vars from tfvars if present
          if [ -f terraform.tfvars ]; then
            terraform plan -input=false -var-file="terraform.tfvars" -var "ssh_key_path=${{ steps.sshkeys.outputs.pub }}"
            terraform apply -auto-approve -input=false -var-file="terraform.tfvars" -var "ssh_key_path=${{ steps.sshkeys.outputs.pub }}"
          else
            terraform plan -input=false -var "ssh_key_path=${{ steps.sshkeys.outputs.pub }}"
            terraform apply -auto-approve -input=false -var "ssh_key_path=${{ steps.sshkeys.outputs.pub }}"
          fi

      - name: Capture droplet IP
        id: tfout
        working-directory: infrastructure/terraform
        run: |
          set -euo pipefail
          ip=$(terraform output -raw droplet_ip)
          echo "Droplet IP: $ip"
          echo "ip=$ip" >> "$GITHUB_OUTPUT"

      - name: Wait for SSH to be ready
        run: |
          set -euo pipefail
          ip='${{ steps.tfout.outputs.ip }}'
          for i in {1..30}; do
            if ssh -o StrictHostKeyChecking=no -o ConnectTimeout=5 -i "${{ steps.sshkeys.outputs.priv }}" root@"$ip" 'echo ready' 2>/dev/null; then
              echo "SSH ready"
              exit 0
            fi
            echo "Waiting for SSH ($i/30)..."; sleep 5
          done
          echo "Droplet not reachable via SSH" >&2
          exit 1

      - name: Install Ansible on runner
        run: |
          sudo apt-get update
          sudo apt-get install -y ansible

      - name: Ansible ping
        run: |
          ansible -i "${{ steps.tfout.outputs.ip }}," all -u root \
            --private-key "${{ steps.sshkeys.outputs.priv }}" \
            -m ping -e "ansible_python_interpreter=/usr/bin/python3"

      - name: Deploy with Ansible playbook
        run: |
          ansible-playbook -i "${{ steps.tfout.outputs.ip }}," infrastructure/ansible/site.yml \
            -u root --private-key "${{ steps.sshkeys.outputs.priv }}" -v \
            -e "ansible_python_interpreter=/usr/bin/python3" \
            -e "ansible_ssh_common_args='-o StrictHostKeyChecking=no'"

      - name: Smoke test services
        run: |
          ip='${{ steps.tfout.outputs.ip }}'
          echo "Checking frontend at http://$ip:3008"
          curl -sSf -m 30 "http://$ip:3008" | head -c 200 >/dev/null && echo "Frontend OK"
          echo "Checking backend health at http://$ip:5001/actuator/health (optional)"
          curl -s -m 10 "http://$ip:5001/actuator/health" || true